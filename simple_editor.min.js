/**
 * simple-editor - Medium.com like editor with plugin architecture
 * @author     James Nicol
 * @repository git@github.com:jimmynicol/simple-editor.git
 * @link       https://github.com/jimmynicol/simple-editor
 * @license    MIT
 */
!function(t,e){"use strict";if("function"==typeof define&&define.amd)define(["jquery"],function(i){return e(t,i)});else if("undefined"!=typeof exports){var i=require("jquery");module.exports=e(t,i)}else t.SimpleEditor=e(t,t.jQuery)}(this,function(t,e){"use strict";var i=Object.prototype.hasOwnProperty,n={_canLog:!1,detectDebugMode:function(){if(window){var t,e;if(!i.call(window,"console"))return;t=this,e=window.location.search.replace(/^\?/,"").split("&");for(var n in e){var o=e[n];/^log=/.test(o)&&(t._canLog=!0)}}},log:function(){this._canLog&&console.log.apply(console,arguments)}};n.detectDebugMode();var o={tidy:function(){this._removeComments(),this._removeTags(),this._removeAttrs(),this.log("tidy complete")},_reTidy:function(){var t=this;this._retidyTimer=setInterval(function(){t.$target.find("p[style]").length>0&&(t.tidy(),clearInterval(t._retidyTimer))},100)},_removeComments:function(){var t=this.$target.html();t=t.replace(/<!--[\s\S]*?-->/g,""),t=e.trim(t),this.$target.html(t)},_removeTags:function(){var t=this;this.log("remove tags"),this.$target.find("*").each(function(i,n){var o=n.tagName.toLowerCase();-1===e.inArray(o,t.options.tagWhiteList)&&e(n).remove()})},_removeAttrs:function(){var t,i=this,n=["a","img"];t=e.map(this.options.tagWhiteList,function(t){return-1===e.inArray(t.toLowerCase(),n)?t.toLowerCase():void 0}),this.log("removeAttrs",t),this.$target.find(t.join(", ")).each(function(t,n){var o=e(n).hasClass(i.options.placeholderClass);if(!o)for(var r=0;r<n.attributes.length;r++){var s=n.attributes[r].name;e(n).removeAttr(s)}});var o=["href","target"];this.$target.find("a").each(function(t,i){for(var n=0;n<i.attributes.length;n++){var r=i.attributes[n].name;-1===e.inArray(r,o)&&e(i).removeAttr(r)}});var r=["src","data-imgid","data-src"];this.$target.find("img").each(function(t,i){for(var n=0;n<i.attributes.length;n++){var o=i.attributes[n].name;-1===e.inArray(o,r)&&e(i).removeAttr(o)}})}},r={bold:function(){this._execCmd("bold")},italic:function(){this._execCmd("italic")},unorderedList:function(){this._execCmd("insertUnorderedList")},heading:function(){this._execCmd("formatBlock","<"+this.options.headingElement+">")},paragraph:function(){this._execCmd("formatBlock","<P>")},link:function(t){var e=this;this._execCmd("createLink",t,function(){e.options.linkTarget.length>0&&e.$target.find("a").prop("target","_blank")})},unlink:function(){this._execCmd("unlink")},undo:function(){this._execCmd("undo")},redo:function(){this._execCmd("redo")},img:function(t,i){var n=this;i=i||{},this.hasPlaceholder&&this._removePlaceholder(),this._registerImgs(),this._execCmd("insertImage",t,function(){n._removeAttrs();var t=e(n._newImg());t.attr("data-src",t.attr("src")),n._registerImgs()})},_registerImgs:function(){this.$target.find("img").each(function(t,i){"undefined"==typeof e(i).data("imgid")&&e(i).data("imgid",t)})},_newImg:function(){var t=this.$target.find("img");for(var i in t){var n=t[i];if("undefined"==typeof e(n).data("imgid"))return n}return null},_execCmd:function(t,e,i){"undefined"==typeof e?document.execCommand(t):document.execCommand(t,!1,e),this.target.focus(),"undefined"!=typeof i&&i.apply(this)}},s=function(t,i){if(i=i||{},this.$target=e(t),0===this.$target.length)throw"The editor needs a valid target!";this.target=this.$target[0],this.hasPlaceholder=!1,this.options={css:{target:i.cssClass||"f-content-section",placeholder:i.placeholderClass||"f-fc-medium f-font-italic f-fs-large"},headingElement:(i.headingElement||"h2").toUpperCase(),minHeight:i.minHeight||100,linkTarget:i.linkTarget||"_blank",placeholder:i.placeholder||this.$target.attr("placeholder")||null,placeholderClass:i.placeholderClass||"SimpleEditor-placeholder"},this.options.tagWhiteList=i.tagWhiteList||["p","b","strong","i","em","span","br","img","ul","li","a",this.options.headingElement.toLowerCase()],this._setupTarget(),this._placeholder(),this._keyboardListeners(),this.log("Simple Editor initialized!",t),this.log("editor options",this.options)};return s.prototype={_setupTarget:function(){var t=this;this.$target.addClass(this.options.css.target),this.$target.prop("contentEditable",!0),this.$target.css({outline:"none",minHeight:this.options.minHeight}),this.$target.on("focus",function(){t.hasPlaceholder&&t.setCursor(0)})},_keyboardListeners:function(){var t=this;this.$target.on("paste",null,function(){setTimeout(function(){t.tidy(),t._reTidy()},100)}),this.$target.on("keydown",function(e){e.metaKey===!0&&(98===e.which&&t.bold(),105===e.which&&t.italic()),t.hasPlaceholder&&!t.isEmpty()&&t._removePlaceholder()}),this.$target.on("keyup",function(){t._placeholder()})},_placeholder:function(){if(this.options.placeholder&&this.isEmpty()&&this.options.placeholder&&!this.hasPlaceholder){var t='<p><span contenteditable="false" ';t+='class="'+this.options.placeholderClass+" ",t+=this.options.css.placeholder+'" contenteditable="false">',t+=this.options.placeholder,t+="</span></p>",this.$target.empty(),this.$target.append(t),this.setCursor(0),this.hasPlaceholder=!0,this.log("added placeholder")}},_removePlaceholder:function(){this.$target.find("."+this.options.placeholderClass).remove(),this.hasPlaceholder=!1,this.log("removed placeholder")},isEmpty:function(){var t=this.$target.text();return 0===e.trim(t).length},contents:function(){return this.tidy(),e.trim(this.$target.html())},setCursor:function(t,i){var n;if(i=i||this.target.lastChild,t="undefined"!=typeof t?t:e(i).text().length-1,t=0>t?0:t,this.log("setCursor",t,i),document.createRange){var o=window.getSelection(),r=i.firstChild;o.collapse(r,t),i.parentNode.focus()}else n=document.body.createTextRange(),n.moveToElementText(i),n.collapse(!1),n.select()}},e.extend(s.prototype,n,o,r),s.VERSION="0.0.1",s});