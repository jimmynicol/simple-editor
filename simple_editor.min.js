/**
 * simple-editor - Medium.com like editor with plugin architecture
 * @author     James Nicol
 * @version    0.5.0
 * @repository git@github.com:jimmynicol/simple-editor.git
 * @link       https://github.com/jimmynicol/simple-editor
 * @license    MIT
 */
!function(t,e){"use strict";if("function"==typeof define&&define.amd)define(["jquery"],function(t){return e(t)});else if("undefined"!=typeof exports){var i=require("jquery");module.exports=e(i)}else t.SimpleEditor=e(t.jQuery)}(this,function(t){"use strict";var e=Object.prototype.hasOwnProperty,i=[].slice,n={_canLog:!1,detectDebugMode:function(){if(window){var t,i;if(!e.call(window,"console"))return;t=this,i=window.location.search.replace(/^\?/,"").split("&");for(var n in i){var o=i[n];/^log=/.test(o)&&(t._canLog=!0)}}},log:function(){if(this._canLog){var t=["SimpleEditor:"].concat(i.call(arguments));console.log.apply(console,t)}}};n.detectDebugMode();var o={tidy:function(){this._removeComments(),this._updateTags(),this._removeTags(),this._removeAttrs()},_reTidy:function(){var t=this;this._retidyTimer=setInterval(function(){t.$target.find("p[style], p[class]").length>0&&(t.tidy(),clearInterval(t._retidyTimer))},100)},_removeComments:function(){var e=this.$target.html();e=e.replace(/<!--[\s\S]*?-->/g,""),e=t.trim(e),this.$target.html(e)},_updateTags:function(){this.$target.find("div").each(function(e,i){var n=t(i),o=t("<p>").html(n.html());t(i).replaceWith(o)}),this.$target.find("> span").each(function(e,i){t(i).wrap("<p></p>")})},_removeTags:function(){var e=this;this.$target.find("*").each(function(i,n){var o=n.tagName.toLowerCase();-1===t.inArray(o,e.options.tagWhiteList)&&t(n).remove()}),this.$target.find("span:empty, a:empty, b:empty, i:empty, strong:empty, em:empty").remove(),this.$target.find("p:empty, li:empty").remove(),this.$target.find(this.options.headingElement+":empty, ul:empty")},_removeAttrs:function(){console.log("_removeAttrs");var e,i=this,n=["a","img"];e=t.map(this.options.tagWhiteList,function(e){return-1===t.inArray(e.toLowerCase(),n)?e.toLowerCase():void 0}),this.$target.find(e.join(", ")).each(function(e,n){var o=t(n).hasClass(i.options.placeholderClass);if(!o)for(var s=0;s<n.attributes.length;s++){var r=n.attributes[s].name;t(n).removeAttr(r)}}),this.$target.find("a").each(function(e,n){for(var o=0;o<n.attributes.length;o++){var s=n.attributes[o].name;-1===t.inArray(s,i.options.attributeWhiteList.a)&&t(n).removeAttr(s)}}),this.$target.find("img").each(function(e,n){for(var o=0;o<n.attributes.length;o++){var s=n.attributes[o].name;-1===t.inArray(s,i.options.attributeWhiteList.img)&&t(n).removeAttr(s)}})}},s={bold:function(){this._execCmd("bold")},italic:function(){this._execCmd("italic")},unorderedList:function(){this._execCmd("insertUnorderedList")},orderedList:function(){this._execCmd("insertOrderedList")},heading:function(){this._execCmd("formatBlock","<"+this.options.headingElement+">")},paragraph:function(){this._execCmd("formatBlock","<P>")},link:function(t,e){var i=this;this._registerTags("a"),this._execCmd("createLink",t,function(){"function"==typeof e&&e.call(i,i._newTag("a")),i._registerTags("a")})},unlink:function(){this._execCmd("unlink")},undo:function(){this._execCmd("undo")},redo:function(){this._execCmd("redo")},img:function(t,e){if("undefined"==typeof t||0===t.length)return void this.log("inserting an image needs a url");var i=this;this.hasPlaceholder&&this._removePlaceholder(),this._registerTags("img"),this._execCmd("insertImage",t,function(){if(i._removeAttrs(),"function"==typeof e){var t=i._newTag("img");e.call(i,t)}i._registerTags("img")})},_registerTags:function(e){var i=e+"id";this.$target.find(e).each(function(e,n){"undefined"==typeof t(n).data(i)&&t(n).data(i,e)})},_newTag:function(e){var i,n=this.$target.find(e),o=e+"id";for(var s in n)if(i=n[s],"undefined"==typeof t(i).data(o))return i;return null},_execCmd:function(t,e,i){"undefined"==typeof e?document.execCommand(t,!1,null):document.execCommand(t,!1,e),this.target.focus(),"undefined"!=typeof i&&i.apply(this)}},r=function(e,i){if(this.log("initializing...",i),i=i||{},this.$target=t(e),0===this.$target.length)throw"The editor needs a valid target!";this.target=this.$target[0],this.hasPlaceholder=!1,this.options={css:{target:i.css.target||"",placeholder:i.css.placeholder||""},minHeight:i.minHeight||100,headingElement:(i.headingElement||"h2").toUpperCase(),placeholder:i.placeholder||this.$target.attr("placeholder")||null,placeholderClass:i.placeholderClass||"SimpleEditor-placeholder",attributeWhiteList:{img:["src"],a:["href","target"]}},i.attributeWhiteList&&t.extend(this.options.attributeWhiteList,i.attributeWhiteList),this.options.tagWhiteList=i.tagWhiteList||["p","b","strong","i","em","span","br","img","ul","li","a",this.options.headingElement.toLowerCase()],i.onInit&&(this.options.onInit=i.onInit),this._setupTarget(),this._placeholder(),this._keyboardListeners(),this.tidy(),this._handleEmptyEditor(),this.options.onInit&&this.options.onInit.call(this),this.trigger("editor:init"),this.log("options",this.options),this.log("initialized!")};return r.prototype={on:function(){this.$target.on.apply(this.$target,arguments)},one:function(){this.$target.one.apply(this.$target,arguments)},off:function(){this.$target.off.apply(this.$target,arguments)},trigger:function(){this.$target.trigger.apply(this.$target,arguments)},_setupTarget:function(){var t=this;this.$target.addClass(this.options.css.target),this.$target.prop("contentEditable",!0),this.$target.css({outline:"none",minHeight:this.options.minHeight});try{document.execCommand("styleWithCSS",!1,!1),document.execCommand("enableObjectResizing",!1,!1)}catch(e){this.log("error running execCommands",e)}this.$target.on("focus",function(){t.hasPlaceholder&&t.setCursor(0)})},_handleEmptyEditor:function(){if(this.isEmpty()){var t=this.$target.css("lineHeight");this.$target.append('<p style="min-height: '+t+'"> </p>'),this.setCursor(0),this.target.focus()}},_keyboardListeners:function(){var t=this;this.$target.on("paste",null,function(){setTimeout(function(){t.tidy(),t._reTidy()},100)}),this.$target.on("keydown",function(e){e.metaKey===!0&&(98===e.which&&t.bold(),105===e.which&&t.italic()),t.hasPlaceholder&&!t.isEmpty()&&t._removePlaceholder()}),this.$target.on("keyup",function(){t._placeholder()})},_placeholder:function(){if(this.options.placeholder&&this.isEmpty()&&this.options.placeholder&&!this.hasPlaceholder){var t='<p><span contenteditable="false" ';t+='class="'+this.options.placeholderClass+" ",t+=this.options.css.placeholder+'" contenteditable="false">',t+=this.options.placeholder,t+="</span></p>",this.$target.empty(),this.$target.append(t),this.setCursor(0),this.hasPlaceholder=!0,this.log("added placeholder")}},_removePlaceholder:function(){this.$target.find("."+this.options.placeholderClass).remove(),this.hasPlaceholder=!1,this.log("removed placeholder")},isEmpty:function(){var e=this.$target.text();return 0===t.trim(e).length?0===this.$target.find("img").length:!1},contents:function(e){this.tidy();var i=this.$target.html();return"function"==typeof e&&(i=e.call(this,i)),t.trim(i)},setCursor:function(e,i){var n;if(i=i||this.target.lastChild,e="undefined"!=typeof e?e:t(i).text().length-1,e=0>e?0:e,document.createRange){var o=window.getSelection();n=document.createRange(),n.setStart(i,e),n.collapse(!0),o.removeAllRanges(),o.addRange(n)}else n=document.body.createTextRange(),n.moveToElementText(i),n.collapse(!1),n.select()},selection:{save:function(){if(window.getSelection){var t=window.getSelection();if(t.rangeCount>0)return t.getRangeAt(0)}else if(document.selection&&document.selection.createRange)return document.selection.createRange();return null},restore:function(t){if(t)if(window.getSelection){var e=window.getSelection();e.removeAllRanges(),e.addRange(t)}else document.selection&&t.select&&t.select()}}},t.extend(r.prototype,n,o,s),r.VERSION="0.5.0",r});